<!DOCTYPE html>
<html lang="th" class=""> <!-- Class for dark mode is controlled by JS -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Advance Fertilizer 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="https://img5.pic.in.th/file/secure-sv1/428709424_3685682595091856_2231537038448980245_n.th.jpg">

    <style>
        /* Base styles */
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f4f5f7;
            transition: background-color 0.3s ease;
        }
        .view { display: none !important; }
        .view.active { display: grid !important; }
        #main-app-view.active { display: block !important; } /* Changed for main view */
        #login-view.active { display: grid !important; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Dark Mode Styles */
        .dark body { background-color: #111827; }
        .dark .bg-white { background-color: #1f2937; }
        .dark .bg-gray-50 { background-color: #374151; }
        .dark .bg-gray-200 { background-color: #374151; }
        .dark .border-b, .dark .border-t { border-color: #374151; }
        .dark .text-gray-800 { color: #f9fafb; }
        .dark .text-gray-600 { color: #d1d5db; }
        .dark .text-gray-500 { color: #9ca3af; }
        .dark .text-gray-400 { color: #6b7280; }
        .dark .form-input, .dark .form-select, .dark .form-textarea {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        .dark .tab-button[data-active='true'] { background-color: #374151; }
        .dark #header-title { color: #f9fafb; }

        /* Active state UI */
        .bottom-nav-item[data-active='true'] { color: #ec4899; }
        .tab-button[data-active='true'] { color: #ec4899; background-color: #fff; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); font-weight: 700; }
        
        /* Form styles */
        .form-input, .form-select, .form-textarea { width: 100%; background-color: #fff; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.75rem; font-size: 1rem; transition: all 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #ec4899; box-shadow: 0 0 0 2px rgba(236, 72, 153, 0.4); }
        .form-label { display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
        .dark .form-label { color: #d1d5db; }

        /* Animation Styles */
        .page-content { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .page-content.active { display: block; opacity: 1; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .list-item-animation { animation: fadeInUp 0.4s ease-out forwards; opacity: 0; }
        
        /* Skeleton Loading Styles */
        .skeleton {
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .dark .skeleton { background-color: #374151; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

    </style>
</head>
<body class="overscroll-none">

    <!-- Login View -->
    <div id="login-view" class="view active place-items-center min-h-screen">
        <div class="w-full max-w-sm p-8 space-y-6">
            <div class="text-center"><img src="https://img5.pic.in.th/file/secure-sv1/428709424_3685682595091856_2231537038448980245_n.th.jpg" class="w-24 h-24 mx-auto rounded-full shadow-md"><h1 class="text-4xl font-bold text-gray-800 mt-4">Advance Fertilizer</h1><p class="text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</p></div>
            <form id="login-form" class="space-y-4">
                <div><label for="username" class="form-label text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label><input id="username" type="text" class="form-input"></div>
                <div><label for="password" class="form-label text-left">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input id="password" type="password" class="form-input"></div>
                <button type="submit" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-lg !mt-6 transform active:scale-95 transition-transform">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <p id="login-error" class="text-red-500 text-center text-sm pt-2 h-6"></p>
            </form>
        </div>
    </div>

    <!-- Main App View -->
    <div id="main-app-view" class="view">
        <div class="flex flex-col h-screen">
            <header class="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-10">
                <button id="back-button" class="hidden text-xl text-gray-600 w-8 text-left"><i class="fas fa-chevron-left"></i></button>
                <h1 id="header-title" class="text-xl font-bold text-gray-800 text-center flex-grow">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h1>
                <div class="flex items-center space-x-4">
                    <!-- üåô START: Dark Mode Toggle -->
                    <button id="theme-toggle" class="text-xl text-gray-600 w-8"><i class="fas fa-moon"></i></button>
                    <!-- üåô END: Dark Mode Toggle -->
                    <button id="logout-button" class="text-xl text-gray-600 w-8 text-right"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>
            
            <main class="flex-1 overflow-y-auto p-4 pb-24">
                <div id="dashboard-page" class="page-content">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-sm text-gray-500">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</p><p id="store-count" class="text-3xl font-bold text-blue-500">0</p></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm text-center"><p class="text-sm text-gray-500">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</p><p id="farmer-count" class="text-3xl font-bold text-green-500">0</p></div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="font-bold mb-2 text-center text-gray-800">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3><div class="max-w-xs mx-auto"><canvas id="doughnutChart"></canvas></div></div>
                </div>
                <div id="feed-page" class="page-content">
                    <div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-bold text-gray-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1><button onclick="showAddFormSelection()" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2"><i class="fas fa-plus"></i><span>‡πÄ‡∏û‡∏¥‡πà‡∏°</span></button></div>
                    <div class="p-1 bg-gray-200 rounded-lg flex space-x-1 mb-4"><button onclick="showTab('stores')" class="tab-button w-1/3 py-2 rounded-md" data-active="true">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button><button onclick="showTab('farmers')" class="tab-button w-1/3 py-2 rounded-md">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</button><button onclick="showTab('trials')" class="tab-button w-1/3 py-2 rounded-md">‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á</button></div>
                    <div class="relative mb-4"><input id="search-input" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠..." class="form-input pl-10"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div>
                    
                    <!-- üîç START: Filter and Sort Controls -->
                    <div id="filter-sort-controls" class="hidden bg-gray-50 p-2 rounded-lg mb-4 space-y-2 md:space-y-0 md:flex md:items-center md:space-x-4">
                        <div class="flex-1">
                            <label class="text-sm font-medium text-gray-500">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
                            <select id="filter-select" class="form-select text-sm p-2">
                                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</option>
                                <option value="‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="text-sm font-medium text-gray-500">‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á:</label>
                            <select id="sort-select" class="form-select text-sm p-2">
                                <option value="newest">‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î</option>
                                <option value="oldest">‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                                <option value="az">‡∏ä‡∏∑‡πà‡∏≠ (A-Z)</option>
                                <option value="za">‡∏ä‡∏∑‡πà‡∏≠ (Z-A)</option>
                            </select>
                        </div>
                    </div>
                    <!-- üîç END: Filter and Sort Controls -->

                    <div id="feed-container">
                        <!-- üíÄ START: Skeleton Loader -->
                        <div id="skeleton-loader" class="space-y-3">
                            <div class="bg-white p-4 rounded-lg shadow-sm flex items-center space-x-4">
                                <div class="skeleton w-8 h-8 rounded-full"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="skeleton h-4 w-3/4"></div>
                                    <div class="skeleton h-3 w-1/2"></div>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm flex items-center space-x-4">
                                <div class="skeleton w-8 h-8 rounded-full"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="skeleton h-4 w-2/3"></div>
                                    <div class="skeleton h-3 w-1/3"></div>
                                </div>
                            </div>
                        </div>
                        <!-- üíÄ END: Skeleton Loader -->
                        <div id="stores-tab" class="tab-content active space-y-3"></div>
                        <div id="farmers-tab" class="tab-content space-y-3"></div>
                        <div id="trials-tab" class="tab-content space-y-3"></div>
                    </div>
                    <p id="empty-feed" class="hidden text-center text-gray-500 py-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
                <div id="detail-page" class="page-content"></div>
                <div id="map-page" class="page-content"><div id="map" class="h-full w-full rounded-lg shadow-md min-h-[calc(100vh-160px)]"></div></div>
            </main>

            <nav class="bg-white border-t flex justify-around p-2 fixed bottom-0 w-full z-10">
                <button onclick="showPage('dashboard')" class="bottom-nav-item flex flex-col items-center text-gray-500 p-2 w-1/3" data-active="true"><i class="fas fa-chart-pie text-2xl"></i><span class="text-xs mt-1">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span></button>
                <button onclick="showPage('feed')" class="bottom-nav-item flex flex-col items-center text-gray-500 p-2 w-1/3"><i class="fas fa-users text-2xl"></i><span class="text-xs mt-1">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span></button>
                <button onclick="showPage('map')" class="bottom-nav-item flex flex-col items-center text-gray-500 p-2 w-1/3"><i class="fas fa-map-marked-alt text-2xl"></i><span class="text-xs mt-1">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span></button>
            </nav>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="form-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center p-4">
        <div id="form-modal-container" class="form-modal-content bg-gray-50 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col"></div>
    </div>
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center w-11/12 max-w-sm"><p id="modal-message" class="text-lg"></p><button onclick="closeMessageModal()" class="mt-4 bg-pink-500 text-white px-6 py-2 rounded-md w-full">‡∏ï‡∏Å‡∏•‡∏á</button></div>
    </div>
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex flex-col items-center justify-center text-white">
        <i class="fas fa-spinner fa-spin text-4xl"></i>
        <p id="loading-text" class="mt-4 text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <script>
        // --- SCRIPT START ---

        // --- üåô START: DARK MODE LOGIC ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleIcon = themeToggle.querySelector('i');

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleIcon.className = 'fas fa-sun';
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleIcon.className = 'fas fa-moon';
            }
        };

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark');
        } else {
            applyTheme('light');
        }
        
        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            const newTheme = isDark ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        // --- üåô END: DARK MODE LOGIC ---

        // --- App State & DOM Elements ---
        let currentUser = null;
        let allData = [];
        let map = null;
        let doughnutChartInstance = null;
        let currentSort = 'newest';
        let currentFilter = 'all';

        const loginView = document.getElementById('login-view');
        const mainAppView = document.getElementById('main-app-view');
        const formModal = document.getElementById('form-modal');
        const formModalContainer = document.getElementById('form-modal-container');
        const loginForm = document.getElementById('login-form');
        const backButton = document.getElementById('back-button');
        const searchInput = document.getElementById('search-input');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const filterControls = document.getElementById('filter-sort-controls');
        const filterSelect = document.getElementById('filter-select');
        const sortSelect = document.getElementById('sort-select');
        const skeletonLoader = document.getElementById('skeleton-loader');
        const emptyFeed = document.getElementById('empty-feed');

        // --- PASTE YOUR SCRIPT URL HERE ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyWYuttyt5bFw3h7jzUhEaWBpowkLikqILd5kaL0V6b_jveMP1Tdpd1gPGqJmqexcLS1g/exec';

        // --- Generic Fetch ---
        async function apiCall(payload, loadingMessage = null) {
            if (loadingMessage) {
                loadingText.textContent = loadingMessage;
                loadingOverlay.classList.remove('hidden');
            }
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    cache: 'no-cache',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } finally {
                if (loadingMessage) {
                    loadingOverlay.classList.add('hidden');
                }
            }
        }

        // --- Auth & Init ---
        async function handleLogin(e) {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            const submitButton = e.target.querySelector('button');
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            submitButton.disabled = true;

            try {
                const data = await apiCall({ action: 'login', username, password }, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...");
                if (data.result === 'success' && data.user) {
                    currentUser = data.user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    initializeApp();
                } else {
                    loginError.textContent = data.message || 'Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                }
            } catch (err) {
                console.error("Login Fetch Error:", err);
                loginError.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
            } finally {
                submitButton.innerHTML = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                submitButton.disabled = false;
            }
        }
        
        async function initializeApp() {
            loginView.classList.remove('active');
            mainAppView.classList.add('active');
            await fetchData(true);
            showPage('dashboard');
        }

        function handleLogout() {
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function checkSession() {
            const user = localStorage.getItem('currentUser');
            if (user) {
                currentUser = JSON.parse(user);
                initializeApp();
            } else {
                loginView.classList.add('active');
            }
        }
        
        // --- UI Navigation ---
        function showPage(pageName, detailData = null) {
            const currentPage = document.querySelector('.page-content.active');
            if (currentPage) {
                currentPage.classList.remove('active');
            }

            setTimeout(() => {
                document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
                const newPage = document.getElementById(`${pageName}-page`);
                newPage.style.display = 'block';
                void newPage.offsetWidth; 
                newPage.classList.add('active');
                
                document.querySelectorAll('.bottom-nav-item').forEach(item => {
                    item.dataset.active = item.getAttribute('onclick').includes(`'${pageName}'`);
                });
                
                document.getElementById('header-title').textContent = { dashboard: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°', feed: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', map: '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', detail: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' }[pageName] || '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°';

                backButton.classList.toggle('hidden', pageName !== 'detail');

                if (pageName === 'detail') renderDetailPage(detailData);
                if (pageName === 'dashboard') initDashboard();
                if (pageName === 'feed') {
                    const activeTab = document.querySelector('.tab-button[data-active="true"]')?.getAttribute('onclick').match(/'(.*?)'/)[1] || 'stores';
                    showTab(activeTab);
                }
                if (pageName === 'map') initMap();
            }, 200);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelectorAll('.tab-button').forEach(b => b.dataset.active = b.getAttribute('onclick').includes(`'${tabName}'`));
            
            filterControls.style.display = (tabName === 'stores') ? 'block' : 'none';
            renderAllTabs();
        }

        // --- Forms ---
        function showAddFormSelection() {
            formModal.classList.remove('hidden');
            formModalContainer.innerHTML = `
                <div class="p-6 text-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                    <div class="space-y-4">
                        <button onclick="generateForm('store')" class="w-full max-w-xs text-lg bg-blue-500 text-white py-3 rounded-lg"><i class="fas fa-store mr-3"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                        <button onclick="generateForm('farmer')" class="w-full max-w-xs text-lg bg-green-500 text-white py-3 rounded-lg"><i class="fas fa-leaf mr-3"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</button>
                        <button onclick="generateForm('trial')" class="w-full max-w-xs text-lg bg-purple-500 text-white py-3 rounded-lg"><i class="fas fa-vial mr-3"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á</button>
                    </div>
                    <button onclick="closeFormModal()" class="mt-8 text-gray-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            `;
        }
        function closeFormModal() {
            formModal.classList.add('hidden');
        }
        
        function generateForm(type, data = {}) {
            const isEdit = Object.keys(data).length > 0 && type !== 'activity';
            let html = '';
            let title = '';
            let formType = '';
            const safeVal = (key) => data[key] || '';

            // ***** FORM FIX: Restoring full forms *****
            if (type === 'store') {
                title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤';
                formType = '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤';
                html = `<div class="p-6 overflow-y-auto"><h3 class="text-xl font-bold mb-6 border-b pb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label><input name="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" class="form-input" required value="${safeVal('‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤')}"></div>
                    <div><label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select name="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" class="form-select"><option ${safeVal('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞') === '‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤' ? 'selected' : ''}>‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤</option><option ${safeVal('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞') === '‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà' ? 'selected' : ''}>‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</option></select></div>
                    <div class="md:col-span-2"><label class="form-label">GPS</label><div class="flex"><input name="GPS" id="gps-input" class="form-input rounded-r-none" value="${safeVal('GPS')}"><button type="button" onclick="getGeoLocation('gps-input')" class="bg-blue-500 text-white px-4 rounded-r-lg"><i class="fas fa-map-marker-alt"></i></button></div></div>
                    <div><label class="form-label">‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label><input name="‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" class="form-input" value="${safeVal('‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤')}"></div>
                    <div><label class="form-label">‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏≤‡∏Å‡∏µ‡πà‡∏õ‡∏µ</label><input name="‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏≤‡∏Å‡∏µ‡πà‡∏õ‡∏µ" type="number" class="form-input" value="${safeVal('‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏≤‡∏Å‡∏µ‡πà‡∏õ‡∏µ')}"></div>
                    <div><label class="form-label">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</label><input name="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å" class="form-input" value="${safeVal('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å')}"></div>
                    <div><label class="form-label">‡∏¢‡∏≠‡∏î‡∏õ‡∏∏‡πã‡∏¢/‡∏õ‡∏µ</label><input name="‡∏¢‡∏≠‡∏î‡∏õ‡∏∏‡πã‡∏¢/‡∏õ‡∏µ" class="form-input" value="${safeVal('‡∏¢‡∏≠‡∏î‡∏õ‡∏∏‡πã‡∏¢/‡∏õ‡∏µ')}"></div>
                    <div><label class="form-label">‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</label><input name="‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô" class="form-input" value="${safeVal('‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô')}"></div>
                    <div><label class="form-label">‡∏û‡∏∑‡∏ä‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label><input name="‡∏û‡∏∑‡∏ä‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà" class="form-input" value="${safeVal('‡∏û‡∏∑‡∏ä‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà')}"></div>
                    <div><label class="form-label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô</label><input name="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô" class="form-input" value="${safeVal('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô')}"></div>
                    <div><label class="form-label">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</label><input name="‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢" class="form-input" value="${safeVal('‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢')}"></div>
                    <div><label class="form-label">‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏ã‡∏≤‡∏õ‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</label><select name="‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏ã‡∏≤‡∏õ‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà" class="form-select"><option ${safeVal('‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏ã‡∏≤‡∏õ‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà') === '‡∏°‡∏µ' ? 'selected' : ''}>‡∏°‡∏µ</option><option ${safeVal('‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏ã‡∏≤‡∏õ‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà') === '‡πÑ‡∏°‡πà‡∏°‡∏µ' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡∏°‡∏µ</option></select></div>
                    <div><label class="form-label">‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</label><select name="‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà" class="form-select"><option ${safeVal('‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà') === '‡∏°‡∏µ' ? 'selected' : ''}>‡∏°‡∏µ</option><option ${safeVal('‡∏°‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà') === '‡πÑ‡∏°‡πà‡∏°‡∏µ' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡∏°‡∏µ</option></select></div>
                    <div><label class="form-label">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô</label><input name="‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô" class="form-input" value="${safeVal('‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô')}"></div>
                    <div><label class="form-label">‡∏£‡∏π‡∏õ‡∏£‡πâ‡∏≤‡∏ô</label><input name="‡∏£‡∏π‡∏õ‡∏£‡πâ‡∏≤‡∏ô" type="file" class="form-input"></div>
                </div>
                <h3 class="text-xl font-bold mt-8 mb-6 border-b pb-4">‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</label><input name="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á" class="form-input" value="${safeVal('‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á')}"></div>
                    <div><label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</label><input name="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á" class="form-input" value="${safeVal('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á')}"></div>
                    <div><label class="form-label">‡πÄ‡∏û‡∏®‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</label><select name="‡πÄ‡∏û‡∏®‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á" class="form-select"><option ${safeVal('‡πÄ‡∏û‡∏®‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á') === '‡∏ä‡∏≤‡∏¢' ? 'selected' : ''}>‡∏ä‡∏≤‡∏¢</option><option ${safeVal('‡πÄ‡∏û‡∏®‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á') === '‡∏´‡∏ç‡∏¥‡∏á' ? 'selected' : ''}>‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
                    <div><label class="form-label">‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</label><input name="‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á" type="number" class="form-input" value="${safeVal('‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á')}"></div>
                    <div><label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</label><input name="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á" class="form-input" value="${safeVal('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á')}"></div>
                    <div><label class="form-label">‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô</label><input name="‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô" type="number" class="form-input" value="${safeVal('‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô')}"></div>
                    <div><label class="form-label">‡∏ä‡∏≠‡∏ö‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå</label><select name="‡∏ä‡∏≠‡∏ö‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå" class="form-select"><option ${safeVal('‡∏ä‡∏≠‡∏ö‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå') === '‡∏ä‡∏≠‡∏ö' ? 'selected' : ''}>‡∏ä‡∏≠‡∏ö</option><option ${safeVal('‡∏ä‡∏≠‡∏ö‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå') === '‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö' ? 'selected' : ''}>‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö</option></select></div>
                    <div><label class="form-label">‡∏á‡∏≤‡∏ô‡∏≠‡∏î‡∏¥‡πÄ‡∏£‡∏Å</label><input name="‡∏á‡∏≤‡∏ô‡∏≠‡∏î‡∏¥‡πÄ‡∏£‡∏Å" class="form-input" value="${safeVal('‡∏á‡∏≤‡∏ô‡∏≠‡∏î‡∏¥‡πÄ‡∏£‡∏Å')}"></div>
                    <div><label class="form-label">‡∏Å‡∏µ‡∏¨‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</label><input name="‡∏Å‡∏µ‡∏¨‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö" class="form-input" value="${safeVal('‡∏Å‡∏µ‡∏¨‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö')}"></div>
                    <div class="md:col-span-2"><label class="form-label">‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏î</label><select name="‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏î" class="form-select"><option ${safeVal('‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏î') === '‡∏ä‡∏≠‡∏ö‡πÄ‡∏à‡πä‡∏≤‡∏∞‡πÅ‡∏à‡πä‡∏∞' ? 'selected' : ''}>‡∏ä‡∏≠‡∏ö‡πÄ‡∏à‡πä‡∏≤‡∏∞‡πÅ‡∏à‡πä‡∏∞</option><option ${safeVal('‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏î') === '‡∏ä‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' ? 'selected' : ''}>‡∏ä‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option><option ${safeVal('‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏î') === '‡∏ä‡∏≠‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á' ? 'selected' : ''}>‡∏ä‡∏≠‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á</option><option ${safeVal('‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏î') === '‡∏ä‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' ? 'selected' : ''}>‡∏ä‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</option></select></div>
                    <div class="md:col-span-2"><label class="form-label">‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏õ‡∏∏‡πã‡∏¢</label><textarea name="‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏õ‡∏∏‡πã‡∏¢" class="form-textarea h-24">${safeVal('‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏õ‡∏∏‡πã‡∏¢')}</textarea></div>
                    <div><label class="form-label">‡∏£‡∏π‡∏õ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô</label><input name="‡∏£‡∏π‡∏õ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô" type="file" class="form-input"></div>
                </div></div>`;
            } else if (type === 'farmer') {
                const stores = allData.filter(d => d.formType === '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
                const storeOptions = stores.map(s => `<option value="${s['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']}" ${safeVal('‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î') === s['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'] ? 'selected' : ''}>${s['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']}</option>`).join('');
                title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£';
                formType = '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£';
                html = `<div class="p-6 overflow-y-auto"><h3 class="text-xl font-bold mb-6 border-b pb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label><input name="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£" class="form-input" required value="${safeVal('‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£')}"></div>
                    <div><label class="form-label">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label><select name="‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î" class="form-select"><option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>${storeOptions}</select></div>
                    <div><label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label><input name="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£" class="form-input" value="${safeVal('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£')}"></div>
                    <div class="md:col-span-2"><label class="form-label">GPS</label><div class="flex"><input name="GPS" id="gps-input" class="form-input rounded-r-none" value="${safeVal('GPS')}"><button type="button" onclick="getGeoLocation('gps-input')" class="bg-blue-500 text-white px-4 rounded-r-lg"><i class="fas fa-map-marker-alt"></i></button></div></div>
                    <div class="md:col-span-2"><label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label><textarea name="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£" class="form-textarea">${safeVal('‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£')}</textarea></div>
                    <div><label class="form-label">‡πÄ‡∏û‡∏®‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label><select name="‡πÄ‡∏û‡∏®‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£" class="form-select"><option ${safeVal('‡πÄ‡∏û‡∏®‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£') === '‡∏ä‡∏≤‡∏¢' ? 'selected' : ''}>‡∏ä‡∏≤‡∏¢</option><option ${safeVal('‡πÄ‡∏û‡∏®‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£') === '‡∏´‡∏ç‡∏¥‡∏á' ? 'selected' : ''}>‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
                    <div><label class="form-label">‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label><input name="‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£" type="number" class="form-input" value="${safeVal('‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£')}"></div>
                    <div><label class="form-label">‡∏õ‡∏•‡∏π‡∏Å‡∏≠‡∏∞‡πÑ‡∏£</label><input name="‡∏õ‡∏•‡∏π‡∏Å‡∏≠‡∏∞‡πÑ‡∏£" class="form-input" value="${safeVal('‡∏õ‡∏•‡∏π‡∏Å‡∏≠‡∏∞‡πÑ‡∏£')}"></div>
                    <div><label class="form-label">‡∏õ‡∏•‡∏π‡∏Å‡∏Å‡∏µ‡πà‡πÑ‡∏£‡πà</label><input name="‡∏õ‡∏•‡∏π‡∏Å‡∏Å‡∏µ‡πà‡πÑ‡∏£‡πà" type="number" class="form-input" value="${safeVal('‡∏õ‡∏•‡∏π‡∏Å‡∏Å‡∏µ‡πà‡πÑ‡∏£‡πà')}"></div>
                    <div><label class="form-label">‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏´‡∏ô</label><input name="‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏´‡∏ô" class="form-input" value="${safeVal('‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏´‡∏ô')}"></div>
                    <div><label class="form-label">‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏õ‡∏µ‡∏•‡∏∞‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£</label><input name="‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏õ‡∏µ‡∏•‡∏∞‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£" class="form-input" value="${safeVal('‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏õ‡∏µ‡∏•‡∏∞‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£')}"></div>
                    <div><label class="form-label">‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô</label><input name="‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô" class="form-input" value="${safeVal('‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô')}"></div>
                    <div><label class="form-label">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label><input name="‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà" class="form-input" value="${safeVal('‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà')}"></div>
                    <div class="md:col-span-2"><label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå</label><textarea name="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå" class="form-textarea">${safeVal('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå')}</textarea></div>
                    <div class="md:col-span-2"><label class="form-label">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label><input name="‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏≠‡∏∑‡πà‡∏ô‡πÜ" class="form-input" value="${safeVal('‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏≠‡∏∑‡πà‡∏ô‡πÜ')}"></div>
                    <div><label class="form-label">‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label><input name="‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£" type="file" class="form-input"></div>
                </div></div>`;
            } else if (type === 'trial') {
                const farmers = allData.filter(d => d.formType === '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£');
                const farmerOptions = farmers.map(f => `<option value="${f['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£']}" ${safeVal('‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á') === f['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£'] ? 'selected' : ''}>${f['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£']}</option>`).join('');
                title = isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á';
                formType = '‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á';
                html = `<div class="p-6 overflow-y-auto"><h3 class="text-xl font-bold mb-6 border-b pb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏ó‡∏≥‡πÅ‡∏õ‡∏•‡∏á</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="form-label">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á</label><select name="‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á" class="form-select"><option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>${farmerOptions}</select></div>
                    <div><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏ß‡∏ô (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£)</label><input name="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏ß‡∏ô" class="form-input" value="${safeVal('‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏ß‡∏ô')}"></div>
                    <div><label class="form-label">‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</label><input name="‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô" class="form-input" value="${safeVal('‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô')}"></div>
                    <div><label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á</label><input name="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á" class="form-input" value="${safeVal('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á')}"></div>
                    <div class="md:col-span-2"><label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á</label><textarea name="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á" class="form-textarea">${safeVal('‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á')}</textarea></div>
                    <div><label class="form-label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏£‡πà)</label><input name="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" type="number" class="form-input" value="${safeVal('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')}"></div>
                    <div><label class="form-label">‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏•‡∏≠‡∏á</label><input name="‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏•‡∏≠‡∏á" class="form-input" value="${safeVal('‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏•‡∏≠‡∏á')}"></div>
                    <div><label class="form-label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏•‡∏≠‡∏á (‡πÑ‡∏£‡πà)</label><input name="‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏•‡∏≠‡∏á" type="number" class="form-input" value="${safeVal('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏•‡∏≠‡∏á')}"></div>
                    <div><label class="form-label">‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏•‡∏≠‡∏á</label><input name="‡∏õ‡∏∏‡πãy‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏•‡∏≠‡∏á" class="form-input" value="${safeVal('‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏•‡∏≠‡∏á')}"></div>
                    <div><label class="form-label">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏î‡∏•‡∏≠‡∏á</label><input name="‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏î‡∏•‡∏≠‡∏á" class="form-input" value="${safeVal('‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏î‡∏•‡∏≠‡∏á')}"></div>
                    <div><label class="form-label">‡∏ó‡∏≥‡∏™‡∏ß‡∏ô‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô</label><input name="‡∏ó‡∏≥‡∏™‡∏ß‡∏ô‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô" class="form-input" value="${safeVal('‡∏ó‡∏≥‡∏™‡∏ß‡∏ô‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô')}"></div>
                    <div class="md:col-span-2"><label class="form-label">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å</label><textarea name="‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å" class="form-textarea">${safeVal('‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å')}</textarea></div>
                </div>
                <h3 class="text-xl font-bold mt-8 mb-6 border-b pb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2"><label class="form-label">GPS ‡πÅ‡∏õ‡∏•‡∏á</label><div class="flex"><input name="GPS‡πÅ‡∏õ‡∏•‡∏á" id="gps-input" class="form-input rounded-r-none" value="${safeVal('GPS‡πÅ‡∏õ‡∏•‡∏á')}"><button type="button" onclick="getGeoLocation('gps-input')" class="bg-blue-500 text-white px-4 rounded-r-lg"><i class="fas fa-map-marker-alt"></i></button></div></div>
                    <div><label class="form-label">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏î‡∏¥‡∏ô</label><input name="‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏î‡∏¥‡∏ô" class="form-input" value="${safeVal('‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏î‡∏¥‡∏ô')}"></div>
                    <div><label class="form-label">‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ</label><input name="‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ" class="form-input" value="${safeVal('‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ')}"></div>
                    <div class="md:col-span-2"><label class="form-label">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏î‡∏•‡∏≠‡∏á</label><textarea name="‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏î‡∏•‡∏≠‡∏á" class="form-textarea">${safeVal('‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏ó‡∏î‡∏•‡∏≠‡∏á')}</textarea></div>
                    <div class="md:col-span-2"><label class="form-label">‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á</label><textarea name="‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á" class="form-textarea">${safeVal('‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á')}</textarea></div>
                    <div><label class="form-label">‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•</label><input name="‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•" type="date" class="form-input" value="${safeVal('‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•')}"></div>
                    <div><label class="form-label">‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</label><select name="‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà" class="form-select"><option ${safeVal('‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà') === '‡πÉ‡∏ä‡πà' ? 'selected' : ''}>‡πÉ‡∏ä‡πà</option><option ${safeVal('‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà') === '‡πÑ‡∏°‡πà' ? 'selected' : ''}>‡πÑ‡∏°‡πà</option><option ${safeVal('‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà') === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö' ? 'selected' : ''}>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö</option></select></div>
                    <div><label class="form-label">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏¥‡∏ô</label><input name="‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏¥‡∏ô" class="form-input" value="${safeVal('‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏¥‡∏ô')}"></div>
                    <div><label class="form-label">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡∏ä</label><input name="‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡∏ä" class="form-input" value="${safeVal('‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏∑‡∏ä')}"></div>
                    <div class="md:col-span-2"><label class="form-label">‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ã‡∏∑‡πâ‡∏≠</label><input name="‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ã‡∏∑‡πâ‡∏≠" class="form-input" value="${safeVal('‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ã‡∏∑‡πâ‡∏≠')}"></div>
                    <div><label class="form-label">‡∏£‡∏π‡∏õ‡πÅ‡∏õ‡∏•‡∏á</label><input name="‡∏£‡∏π‡∏õ‡πÅ‡∏õ‡∏•‡∏á" type="file" class="form-input"></div>
                </div></div>`;
            } else if (type === 'activity') {
                title = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
                formType = '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
                html = `<div class="p-6 overflow-y-auto">
                    <input type="hidden" name="parentId" value="${safeVal('parentId')}">
                    <div><label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label><select name="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó" class="form-select"><option>‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö</option><option>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</option><option>‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select></div>
                    <div class="mt-4"><label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea name="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" class="form-textarea h-32" required></textarea></div>
                </div>`;
            }

            formModalContainer.innerHTML = `
                <header class="p-4 flex items-center border-b sticky top-0 bg-white"><h2 class="text-xl font-bold text-gray-800 text-center flex-grow">${title}</h2><button onclick="closeFormModal()"><i class="fas fa-times text-2xl text-gray-600"></i></button></header>
                <form id="data-form" class="flex-1 overflow-y-auto">
                    <input type="hidden" name="formType" value="${formType}">
                    <input type="hidden" name="rowId" value="${safeVal('rowId')}">
                    ${html}
                    <div class="p-6 mt-auto bg-gray-50 border-t"><button type="submit" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 rounded-lg">${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</button></div>
                </form>
            `;
            formModal.classList.remove('hidden');
            document.getElementById('data-form').addEventListener('submit', handleFormSubmit);
        }

        // --- Data Handling ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            submitButton.disabled = true;

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const isEdit = data.rowId && data.rowId !== '' && data.formType !== '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
            
            const payload = { 
                action: isEdit ? 'updateData' : 'saveData', 
                payload: data,
                user: currentUser
            };

            try {
                const response = await apiCall(payload, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
                if (response.result === 'success') {
                    showMessageModal(isEdit ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    closeFormModal();
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await fetchData(true);
                } else {
                    throw new Error(response.message || 'Unknown error from server');
                }
            } catch (error) {
                console.error("Submit Error:", error);
                showMessageModal(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${error.message}`);
            } finally {
                submitButton.innerHTML = isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                submitButton.disabled = false;
            }
        }

        async function fetchData(force = false) {
            if (!currentUser) return;
            if (allData.length > 0 && !force) {
                renderAllTabs();
                return;
            }
            skeletonLoader.style.display = 'block';
            document.querySelectorAll('.tab-content').forEach(el => el.innerHTML = '');
            emptyFeed.classList.add('hidden');
            
            try {
                const response = await apiCall({
                    action: 'getData',
                    username: currentUser.username,
                    role: currentUser.role,
                    team: currentUser.team || ''
                });
                if(response.result === 'success' && Array.isArray(response.data)) {
                    allData = response.data;
                    renderAllTabs();
                    initDashboard();
                } else {
                   throw new Error(response.message || "Invalid data format from server");
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                emptyFeed.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
                emptyFeed.classList.remove('hidden');
            } finally {
                skeletonLoader.style.display = 'none';
            }
        }
        
        function renderAllTabs() {
            renderDataList('stores');
            renderDataList('farmers');
            renderDataList('trials');
        }

        function renderDataList(tabId) {
            const container = document.getElementById(`${tabId}-tab`);
            const formTypeMapping = { stores: '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', farmers: '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£', trials: '‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á' };
            const formType = formTypeMapping[tabId];
            const searchTerm = searchInput.value.toLowerCase();
            
            let filteredData = allData.filter(item => {
                if (item.formType !== formType) return false;
                const name = String(item['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'] || item['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£'] || item['‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á'] || item['‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏•‡∏≠‡∏á'] || '');
                return name.toLowerCase().includes(searchTerm);
            });

            if (formType === '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤') {
                if (currentFilter !== 'all') {
                    filteredData = filteredData.filter(item => item['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] === currentFilter);
                }
                filteredData.sort((a, b) => {
                    const nameA = a['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'] || '';
                    const nameB = b['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'] || '';
                    switch (currentSort) {
                        case 'newest': return new Date(b.createdDate) - new Date(a.createdDate);
                        case 'oldest': return new Date(a.createdDate) - new Date(b.createdDate);
                        case 'az': return nameA.localeCompare(nameB, 'th');
                        case 'za': return nameB.localeCompare(nameA, 'th');
                        default: return 0;
                    }
                });
            } else {
                 filteredData.sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));
            }

            container.innerHTML = '';
            if (filteredData.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
                return;
            }

            filteredData.forEach((item, index) => {
                const name = item['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'] || item['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£'] || item['‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á'] || item['‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏•‡∏≠‡∏á'] || 'N/A';
                const subtext = item['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á'] || item['‡∏õ‡∏•‡∏π‡∏Å‡∏≠‡∏∞‡πÑ‡∏£'] || `‡πÇ‡∏î‡∏¢: ${item.createdBy}`;
                const iconClass = { '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤': 'fa-store text-blue-500', '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£': 'fa-leaf text-green-500', '‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á': 'fa-vial text-purple-500' }[item.formType] || 'fa-question-circle';

                const row = document.createElement('div');
                row.className = 'bg-white p-4 rounded-lg shadow-sm flex items-center justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 list-item-animation';
                row.style.animationDelay = `${index * 50}ms`;
                row.onclick = () => showPage("detail", item);
                row.innerHTML = `
                    <div class="flex items-center space-x-4 overflow-hidden">
                        <i class="fas ${iconClass} text-xl w-6 text-center"></i>
                        <div class="overflow-hidden">
                            <p class="font-semibold text-gray-800 truncate">${name}</p>
                            <p class="text-sm text-gray-500 truncate">${subtext}</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                `;
                container.appendChild(row);
            });
        }
        
        function handleEditClick(data) {
            const type = { '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤': 'store', '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£': 'farmer', '‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á': 'trial' }[data.formType];
            if (type) generateForm(type, data);
        }

        function renderDetailPage(data) {
            const container = document.getElementById('detail-page');
            container.innerHTML = '';
            let detailsHtml = '';
            let linkedHtml = '';
            const mainName = data['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'] || data['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£'] || data['‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á'] || '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';

            for (const [key, value] of Object.entries(data)) {
                if (value && !['formType', 'rowId', 'sheetRow'].some(k => key.startsWith(k)) && !key.startsWith('creator')) {
                    detailsHtml += `<div class="flex justify-between py-3 border-b"><span class="text-gray-500 w-1/3 break-words">${key}</span><span class="font-semibold text-right w-2/3 break-words">${value}</span></div>`;
                }
            }

            if (data.formType === '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤') {
                const linkedFarmers = allData.filter(f => f.formType === '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£' && f['‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î'] === data['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤']);
                if(linkedFarmers.length > 0) {
                    linkedHtml += `<h3 class="text-lg font-bold mt-6 mb-2 border-t pt-4">‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</h3><div class="space-y-2">`;
                    linkedFarmers.forEach(farmer => {
                        const farmerDataString = JSON.stringify(farmer).replace(/"/g, '&quot;');
                        linkedHtml += `<button onclick='showPage("detail", JSON.parse(this.dataset.farmer))' data-farmer="${farmerDataString}" class="w-full text-left bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 p-3 rounded-lg flex justify-between items-center transition">
                            <span><i class="fas fa-leaf text-green-500 mr-2"></i>${farmer['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£']}</span><i class="fas fa-chevron-right text-gray-400"></i></button>`;
                    });
                    linkedHtml += '</div>';
                }
            }
            
            const activityTabHtml = `
                <div class="mt-6 border-t pt-4">
                    <div class="flex border-b">
                        <button id="detail-tab-info" class="py-2 px-4 font-semibold border-b-2 border-pink-500 text-pink-500">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                        <button id="detail-tab-activity" class="py-2 px-4 font-semibold text-gray-500">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
                    </div>
                    <div id="detail-content-info" class="mt-4">${detailsHtml}${linkedHtml}</div>
                    <div id="detail-content-activity" class="hidden mt-4 space-y-3">
                        <button onclick="generateForm('activity', { parentId: '${data.rowId}' })" class="w-full bg-blue-500 text-white py-2 rounded-lg mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
                        <div id="activity-list">
                            <p class="text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                        </div>
                    </div>
                </div>
            `;
            
            const dataString = JSON.stringify(data).replace(/"/g, '&quot;');
            container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">${mainName}</h2>
                    ${data.formType !== '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°' ? `<button onclick='handleEditClick(JSON.parse(this.dataset.item))' data-item="${dataString}" class="text-blue-500 hover:text-blue-700 text-lg"><i class="fas fa-pencil-alt"></i></button>` : ''}
                </div>
                ${activityTabHtml}
            </div>`;

            const infoTab = document.getElementById('detail-tab-info');
            const activityTab = document.getElementById('detail-tab-activity');
            const infoContent = document.getElementById('detail-content-info');
            const activityContent = document.getElementById('detail-content-activity');

            const switchDetailTab = (active) => {
                const isActiveInfo = active === 'info';
                infoTab.classList.toggle('border-pink-500', isActiveInfo);
                infoTab.classList.toggle('text-pink-500', isActiveInfo);
                activityTab.classList.toggle('border-pink-500', !isActiveInfo);
                activityTab.classList.toggle('text-pink-500', !isActiveInfo);
                infoContent.classList.toggle('hidden', !isActiveInfo);
                activityContent.classList.toggle('hidden', isActiveInfo);
                if (!isActiveInfo) loadActivities(data.rowId);
            };

            infoTab.addEventListener('click', () => switchDetailTab('info'));
            activityTab.addEventListener('click', () => switchDetailTab('activity'));
        }

        function loadActivities(parentId) {
            const activityListContainer = document.getElementById('activity-list');
            const activities = allData
                .filter(item => item.formType === '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°' && item.parentId === parentId)
                .sort((a,b) => new Date(b.createdDate) - new Date(a.createdDate));
            
            if (activities.length === 0) {
                activityListContainer.innerHTML = `<p class="text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>`;
                return;
            }

            activityListContainer.innerHTML = activities.map(act => `
                <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-gray-800">${act['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']}</p>
                        <p class="text-xs text-gray-400">${new Date(act.createdDate).toLocaleDateString('th-TH')}</p>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">${act['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î']}</p>
                    <p class="text-xs text-gray-400 text-right mt-2">‡πÇ‡∏î‡∏¢: ${act.createdBy}</p>
                </div>
            `).join('');
        }

        // --- Dashboard & Map (Simplified for brevity, no major changes) ---
        function initDashboard() {
            if (allData.length === 0) return;
            document.getElementById('store-count').textContent = allData.filter(d => d.formType === '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤').length;
            document.getElementById('farmer-count').textContent = allData.filter(d => d.formType === '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£').length;
            initDashboardCharts();
        }

        function initDashboardCharts() {
            if (doughnutChartInstance) doughnutChartInstance.destroy();
            const doughnutCtx = document.getElementById('doughnutChart').getContext('2d');
            const storeCount = allData.filter(d => d.formType === '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤').length;
            const farmerCount = allData.filter(d => d.formType === '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£').length;
            const trialCount = allData.filter(d => d.formType === '‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á').length;
            doughnutChartInstance = new Chart(doughnutCtx, { type: 'doughnut', data: { labels: ['‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£', '‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á'], datasets: [{ data: [storeCount, farmerCount, trialCount], backgroundColor: ['#3b82f6', '#22c55e', '#a855f7'], hoverOffset: 4 }] } });
        }

        function initMap() {
            if (map) { map.invalidateSize(); plotDataOnMap(); return; }
            map = L.map('map').setView([13.7563, 100.5018], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const coords = [pos.coords.latitude, pos.coords.longitude];
                    map.setView(coords, 13);
                    L.marker(coords, { icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41] }), isCurrentUser: true }).addTo(map).bindPopup('<b>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</b>').openPopup();
                });
            }
            if (allData.length > 0) plotDataOnMap();
        }

        function plotDataOnMap() {
            if (!map) return;
            map.eachLayer(layer => { if (layer instanceof L.Marker && !layer.options.isCurrentUser) map.removeLayer(layer); });
            allData.forEach(item => {
                const gps = item['GPS'] || item['GPS‡πÅ‡∏õ‡∏•‡∏á'];
                if (gps && gps.includes(',')) {
                    const [lat, lon] = gps.split(',').map(s => parseFloat(s.trim()));
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const name = item['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'] || item['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£'] || item['‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á'] || 'N/A';
                        const iconColor = { '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤': 'blue', '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£': 'green', '‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏î‡∏•‡∏≠‡∏á': 'violet' }[item.formType] || 'grey';
                        const markerIcon = new L.Icon({ iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${iconColor}.png`, shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41] });
                        L.marker([lat, lon], {icon: markerIcon}).addTo(map).bindPopup(`<b>${name}</b><br><a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" class="text-blue-600 font-bold">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</a>`);
                    }
                }
            });
        }
        
        // --- Utilities ---
        function showMessageModal(message) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-message').innerText = message;
            modal.classList.remove('hidden');
        }
        function closeMessageModal() {
            document.getElementById('message-modal').classList.add('hidden');
        }
        function getGeoLocation(elementId) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => { document.getElementById(elementId).value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`; },
                    err => { showMessageModal(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`); }
                );
            } else { showMessageModal("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation"); }
        }

        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        backButton.addEventListener('click', () => showPage('feed'));
        searchInput.addEventListener('input', () => renderAllTabs());
        filterSelect.addEventListener('change', (e) => { currentFilter = e.target.value; renderAllTabs(); });
        sortSelect.addEventListener('change', (e) => { currentSort = e.target.value; renderAllTabs(); });

        // --- Initial Load ---
        checkSession();
    </script>
</body>
</html>
